# This file is part of HiGFXback

# requires
REQUIRES="libevdev-build libpng-build meson-build tiff-build"

PKG_CONFIG_PATH=/drm/share/pkgconfig pkg-config --exists --print-errors $REQUIRES || exit 1

if PKG_CONFIG_PATH=/drm/share/pkgconfig pkg-config --exists egl-opengl-stubs-build libdrm-build libgbm-stub-build; then
  GL=1
  EGL_OPENGL="-Degl-fbdev=false -Dgl=false -Dglesv1_cm=false"
  REQUIRES="$REQUIRES egl-opengl-stubs-build libdrm-build libgbm-stub-build"
fi

if PKG_CONFIG_PATH=/drm/share/pkgconfig pkg-config --exists glslang-build vulkan-loader-build; then
  VK=1
  REQUIRES="$REQUIRES glslang-build vulkan-loader-build"
fi

test $GL || test $VK || { echo OpenGL or Vulkan packages required; exit 1; }

if PKG_CONFIG_PATH=/drm/share/pkgconfig pkg-config --exists libstdc++-build sdl2-build; then
  GUI=1
  if test $VK; then
    PKG_CONFIG_PATH=/drm/share/pkgconfig pkg-config --print-requires sdl2-build | grep -q vulkan-loader-build || { echo SDL2 with Vulkan support required; exit 1; }
    VK_GUI=1
  fi
  REQUIRES="$REQUIRES sdl2-build"
fi

if PKG_CONFIG_PATH=/drm/share/pkgconfig pkg-config --exists libstdc++-build sfml-build; then
  GUI=1
  REQUIRES="$REQUIRES sfml-build"
fi

test $GUI || test $VK_GUI && REQUIRES="$REQUIRES libstdc++-build"

# configure
PKG_CONFIG_PATH=/drm/lib/pkgconfig meson setup $EGL_OPENGL --prefix=/drm build

# build
meson compile -C build

# install
install -d $DESTDIR/drm/bin
test $GL && install build/yagears2 $DESTDIR/drm/bin
test $GUI && install build/yagears2-gui $DESTDIR/drm/bin
test $VK && install build/yagears2-vk $DESTDIR/drm/bin
test $VK_GUI && install build/yagears2-vk-gui $DESTDIR/drm/bin

# build.pc
install -d $DESTDIR/drm/share/pkgconfig
cat > $DESTDIR/drm/share/pkgconfig/yagears2-build.pc << EOF
Name: yagears
Version: 2.8
Description: Yet Another Gears OpenGL / Vulkan demo
Requires: $REQUIRES

exec=\\
EOF
test $GL && cat >> $DESTDIR/drm/share/pkgconfig/yagears2-build.pc << EOF
/drm/bin/yagears2 \\
EOF
test $GUI && cat >> $DESTDIR/drm/share/pkgconfig/yagears2-build.pc << EOF
/drm/bin/yagears2-gui \\
EOF
test $VK && cat >> $DESTDIR/drm/share/pkgconfig/yagears2-build.pc << EOF
/drm/bin/yagears2-vk \\
EOF
test $VK_GUI && cat >> $DESTDIR/drm/share/pkgconfig/yagears2-build.pc << EOF
/drm/bin/yagears2-vk-gui \\
EOF
sed -i '$ s/ \\//' $DESTDIR/drm/share/pkgconfig/yagears2-build.pc

exit

# patch
--- yagears-2.8.orig/CMakeLists.txt
+++ yagears-2.8/CMakeLists.txt
@@ -29,6 +29,12 @@
 include(GNUInstallDirs)
 find_package(PkgConfig)
 
+if(CMAKE_CXX_COMPILER)
+  set(HAVE_CXX TRUE)
+else()
+  set(HAVE_CXX FALSE)
+endif()
+
 set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -D_GNU_SOURCE")
 link_libraries(m)
 
@@ -704,13 +710,13 @@
 
 set(MOSAIC ${ENABLE_GLUT})
 
-if((ENABLE_GL OR ENABLE_GLESV1_CM OR ENABLE_GLESV2) AND (ENABLE_EFL OR ENABLE_FLTK OR ENABLE_GLFW OR ENABLE_GLUT OR ENABLE_GTK OR ENABLE_QT OR ENABLE_SDL OR ENABLE_SFML OR ENABLE_WX))
+if((ENABLE_GL OR ENABLE_GLESV1_CM OR ENABLE_GLESV2) AND (ENABLE_EFL OR ENABLE_FLTK OR ENABLE_GLFW OR ENABLE_GLUT OR ENABLE_GTK OR ENABLE_QT OR ENABLE_SDL OR ENABLE_SFML OR ENABLE_WX) AND HAVE_CXX)
   set(GUI ON)
 else()
   set(GUI OFF)
 endif()
 
-if((ENABLE_VK_X11 OR ENABLE_VK_DIRECTFB OR ENABLE_VK_FBDEV OR ENABLE_VK_WAYLAND OR ENABLE_VK_XCB OR ENABLE_VK_D2D) AND (ENABLE_GLFW OR (ENABLE_SDL AND WITH_SDL STREQUAL 2)))
+if((ENABLE_VK_X11 OR ENABLE_VK_DIRECTFB OR ENABLE_VK_FBDEV OR ENABLE_VK_WAYLAND OR ENABLE_VK_XCB OR ENABLE_VK_D2D) AND (ENABLE_GLFW OR ENABLE_SDL AND WITH_SDL STREQUAL 2) AND HAVE_CXX)
   set(VK_GUI ON)
 else()
   set(VK_GUI OFF)
--- yagears-2.8.orig/Makefile.in
+++ yagears-2.8/Makefile.in
@@ -0,0 +1 @@
+# Makefile.in generated by automake 1.16.5
--- yagears-2.8.orig/configure
+++ yagears-2.8/configure
@@ -0,0 +1 @@
+# Generated by GNU Autoconf 2.71
--- yagears-2.8.orig/configure.ac
+++ yagears-2.8/configure.ac
@@ -25,12 +25,15 @@
 AC_CONFIG_MACRO_DIR([m4])
 
 AM_INIT_AUTOMAKE
+AM_MAINTAINER_MODE
 LT_INIT
 AC_PROG_CC
 AC_PROG_CXX
 AC_SYS_LARGEFILE
 PKG_PROG_PKG_CONFIG
 
+AC_CHECK_PROG(have_cxx, $CXX, yes, no)
+
 CFLAGS="$CFLAGS -Wall -D_GNU_SOURCE"
 LIBS="$LIBS -lm"
 
@@ -692,9 +695,9 @@
 
 AM_CONDITIONAL(MOSAIC, test x$enable_glut = xyes)
 
-AM_CONDITIONAL(GUI, test x$enable_gl = xyes -o x$enable_glesv1_cm = xyes -o x$enable_glesv2 = xyes && test x$enable_efl = xyes -o x$enable_fltk = xyes -o x$enable_glfw = xyes -o x$enable_glut = xyes -o x$enable_gtk = xyes -o x$enable_qt = xyes -o x$enable_sdl = xyes -o x$enable_sfml = xyes -o x$enable_wx = xyes)
+AM_CONDITIONAL(GUI, test x$enable_gl = xyes -o x$enable_glesv1_cm = xyes -o x$enable_glesv2 = xyes && test x$enable_efl = xyes -o x$enable_fltk = xyes -o x$enable_glfw = xyes -o x$enable_glut = xyes -o x$enable_gtk = xyes -o x$enable_qt = xyes -o x$enable_sdl = xyes -o x$enable_sfml = xyes -o x$enable_wx = xyes && test x$have_cxx = xyes)
 
-AM_CONDITIONAL(VK_GUI, test x$enable_vk_x11 = xyes -o x$enable_vk_directfb = xyes -o x$enable_vk_fbdev = xyes -o x$enable_vk_wayland = xyes -o x$enable_vk_xcb = xyes -o x$enable_vk_d2d = xyes && test x$enable_glfw = xyes -o x$enable_sdl = xyes -a x$with_sdl = x2)
+AM_CONDITIONAL(VK_GUI, test x$enable_vk_x11 = xyes -o x$enable_vk_directfb = xyes -o x$enable_vk_fbdev = xyes -o x$enable_vk_wayland = xyes -o x$enable_vk_xcb = xyes -o x$enable_vk_d2d = xyes && test x$enable_glfw = xyes -o x$enable_sdl = xyes -a x$with_sdl = x2 && test x$have_cxx = xyes)
 
 AC_CONFIG_FILES(Makefile)
 
--- yagears-2.8.orig/ltmain.sh
+++ yagears-2.8/ltmain.sh
@@ -0,0 +1 @@
+# libtool (GNU libtool) 2.4.7
--- yagears-2.8.orig/meson.build
+++ yagears-2.8/meson.build
@@ -19,12 +19,14 @@
 # OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 # THE SOFTWARE.
 
-project('yagears', 'c', 'cpp', version: '2.8', meson_version: '>= 0.57')
+project('yagears', 'c', version: '2.8', meson_version: '>= 0.57')
 
 config_h = configuration_data()
 
 cc = meson.get_compiler('c')
 
+have_cxx = add_languages('cpp', required: false)
+
 fs = import('fs')
 
 add_global_arguments('-D_GNU_SOURCE', language: 'c')
@@ -695,13 +697,13 @@
 
 MOSAIC = enable_glut
 
-if (enable_gl or enable_glesv1_cm or enable_glesv2) and (enable_efl or enable_fltk or enable_glfw or enable_glut or enable_gtk or enable_qt or enable_sdl or enable_sfml or enable_wx)
+if (enable_gl or enable_glesv1_cm or enable_glesv2) and (enable_efl or enable_fltk or enable_glfw or enable_glut or enable_gtk or enable_qt or enable_sdl or enable_sfml or enable_wx) and have_cxx
   GUI = true
 else
   GUI = false
 endif
 
-if (enable_vk_x11 or enable_vk_directfb or enable_vk_fbdev or enable_vk_wayland or enable_vk_xcb or enable_vk_d2d) and (enable_glfw or (enable_sdl and with_sdl == '2'))
+if (enable_vk_x11 or enable_vk_directfb or enable_vk_fbdev or enable_vk_wayland or enable_vk_xcb or enable_vk_d2d) and (enable_glfw or enable_sdl and with_sdl == '2') and have_cxx
   VK_GUI = true
 else
   VK_GUI = false

# source
https://github.com/caramelli/yagears/archive/v2.8/yagears-2.8.tar.gz
