# This file is part of HiGFXback

# requires
REQUIRES="autotools-wrappers-lt-build directfb2-build"

PKG_CONFIG_PATH=/dfb/share/pkgconfig pkg-config --exists --print-errors $REQUIRES || exit 1

pkg-config --exists alsa-lib-build && REQUIRES="$REQUIRES alsa-lib-build"

if PKG_CONFIG_PATH=/dfb/share/pkgconfig pkg-config --exists egl-opengl-stubs-build; then
  GL=1
  REQUIRES="$REQUIRES egl-opengl-stubs-build"
fi

if PKG_CONFIG_PATH=/dfb/share/pkgconfig pkg-config --exists fusionsound2-build; then
  FUSIONSOUND=--enable-fusionsound
  REQUIRES="$REQUIRES fusionsound2-build"
fi

if PKG_CONFIG_PATH=/dfb/share/pkgconfig pkg-config --exists vulkan-loader-build; then
  VK=1
  REQUIRES="$REQUIRES vulkan-loader-build"
fi

# configure (ac-2.69; lt-2.4.2)
libtoolize -c -f -i; cat acinclude/* > aclocal.m4; autoconf
cd test; cp acinclude.m4 aclocal.m4; autoconf; cd -
rm -rf src/video/khronos
PKG_CONFIG_PATH=/dfb/lib/pkgconfig LDFLAGS=-Wl,-rpath,/dfb/lib ./configure --disable-static --enable-video-directfb $FUSIONSOUND --prefix=/dfb
cd test; SDL_CFLAGS="-I../include -I/dfb/include -I/dfb/include/directfb" SDL_LIBS="-L../build/.libs -lSDL2 -Wl,-rpath,/dfb/lib" ./configure --with-testdatadir=/dfb/share/SDL2/test; cd -

# build
make
make -C test

# install
install -d $DESTDIR/dfb/include/SDL2
install -m 644 include/begin_code.h $DESTDIR/dfb/include/SDL2
install -m 644 include/close_code.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_assert.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_atomic.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_audio.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_blendmode.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_clipboard.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_config.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_cpuinfo.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_endian.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_error.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_events.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_filesystem.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_gamecontroller.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_gesture.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_haptic.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_hints.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_joystick.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_keyboard.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_keycode.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_loadso.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_locale.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_log.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_main.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_messagebox.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_misc.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_mouse.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_mutex.h $DESTDIR/dfb/include/SDL2
test $GL && install -m 644 include/SDL_opengl.h $DESTDIR/dfb/include/SDL2
test $GL && install -m 644 include/SDL_opengl_glext.h $DESTDIR/dfb/include/SDL2
test $GL && install -m 644 include/SDL_opengles.h $DESTDIR/dfb/include/SDL2
test $GL && install -m 644 include/SDL_opengles2.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_pixels.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_platform.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_power.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_quit.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_rect.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_render.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_rwops.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_scancode.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_sensor.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_shape.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_stdinc.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_surface.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_system.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_thread.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_timer.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_touch.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_version.h $DESTDIR/dfb/include/SDL2
install -m 644 include/SDL_video.h $DESTDIR/dfb/include/SDL2
test $VK && install -m 644 include/SDL_vulkan.h $DESTDIR/dfb/include/SDL2
install -d $DESTDIR/dfb/lib
install ./build/.libs/libSDL2-2.0.so.0.* $DESTDIR/dfb/lib/libSDL2-2.0.so.0
ln -sf libSDL2-2.0.so.0 $DESTDIR/dfb/lib/libSDL2.so
install -d $DESTDIR/dfb/lib/pkgconfig
install -m 644 sdl2.pc $DESTDIR/dfb/lib/pkgconfig
install -d $DESTDIR/dfb/share/SDL2/test
install -m 644 test/axis.bmp $DESTDIR/dfb/share/SDL2/test
install -m 644 test/button.bmp $DESTDIR/dfb/share/SDL2/test
install test/checkkeys $DESTDIR/dfb/share/SDL2/test
install test/checkkeysthreads $DESTDIR/dfb/share/SDL2/test
install test/controllermap $DESTDIR/dfb/share/SDL2/test
install -m 644 test/controllermap.bmp $DESTDIR/dfb/share/SDL2/test
install -m 644 test/controllermap_back.bmp $DESTDIR/dfb/share/SDL2/test
install test/loopwave $DESTDIR/dfb/share/SDL2/test
install test/loopwavequeue $DESTDIR/dfb/share/SDL2/test
install -m 644 test/icon.bmp $DESTDIR/dfb/share/SDL2/test
install -m 644 test/moose.dat $DESTDIR/dfb/share/SDL2/test
install -m 644 test/sample.bmp $DESTDIR/dfb/share/SDL2/test
install -m 644 test/sample.wav $DESTDIR/dfb/share/SDL2/test
install test/testatomic $DESTDIR/dfb/share/SDL2/test
install test/testaudiocapture $DESTDIR/dfb/share/SDL2/test
install test/testaudiohotplug $DESTDIR/dfb/share/SDL2/test
install test/testaudioinfo $DESTDIR/dfb/share/SDL2/test
install test/testautomation $DESTDIR/dfb/share/SDL2/test
install test/testbounds $DESTDIR/dfb/share/SDL2/test
install test/testcustomcursor $DESTDIR/dfb/share/SDL2/test
install test/testdisplayinfo $DESTDIR/dfb/share/SDL2/test
install test/testdraw2 $DESTDIR/dfb/share/SDL2/test
install test/testdrawchessboard $DESTDIR/dfb/share/SDL2/test
install test/testdropfile $DESTDIR/dfb/share/SDL2/test
install test/testerror $DESTDIR/dfb/share/SDL2/test
install test/testevdev $DESTDIR/dfb/share/SDL2/test
install test/testfile $DESTDIR/dfb/share/SDL2/test
install test/testfilesystem $DESTDIR/dfb/share/SDL2/test
install test/testgamecontroller $DESTDIR/dfb/share/SDL2/test
install test/testgesture $DESTDIR/dfb/share/SDL2/test
test $GL && install test/testgl2 $DESTDIR/dfb/share/SDL2/test
test $GL && install test/testgles $DESTDIR/dfb/share/SDL2/test
test $GL && install test/testgles2 $DESTDIR/dfb/share/SDL2/test
install test/testhaptic $DESTDIR/dfb/share/SDL2/test
install test/testhotplug $DESTDIR/dfb/share/SDL2/test
install test/testiconv $DESTDIR/dfb/share/SDL2/test
install test/testime $DESTDIR/dfb/share/SDL2/test
install test/testintersections $DESTDIR/dfb/share/SDL2/test
install test/testjoystick $DESTDIR/dfb/share/SDL2/test
install test/testkeys $DESTDIR/dfb/share/SDL2/test
install test/testloadso $DESTDIR/dfb/share/SDL2/test
install test/testlocale $DESTDIR/dfb/share/SDL2/test
install test/testlock $DESTDIR/dfb/share/SDL2/test
install test/testmultiaudio $DESTDIR/dfb/share/SDL2/test
install test/testoverlay2 $DESTDIR/dfb/share/SDL2/test
install test/testplatform $DESTDIR/dfb/share/SDL2/test
install test/testpower $DESTDIR/dfb/share/SDL2/test
install test/testqsort $DESTDIR/dfb/share/SDL2/test
install test/testrelative $DESTDIR/dfb/share/SDL2/test
install test/testrendercopyex $DESTDIR/dfb/share/SDL2/test
install test/testrendertarget $DESTDIR/dfb/share/SDL2/test
install test/testresample $DESTDIR/dfb/share/SDL2/test
install test/testrumble $DESTDIR/dfb/share/SDL2/test
install test/testscale $DESTDIR/dfb/share/SDL2/test
install test/testsem $DESTDIR/dfb/share/SDL2/test
install test/testsensor $DESTDIR/dfb/share/SDL2/test
install test/testsprite2 $DESTDIR/dfb/share/SDL2/test
install test/testspriteminimal $DESTDIR/dfb/share/SDL2/test
install test/teststreaming $DESTDIR/dfb/share/SDL2/test
install test/testthread $DESTDIR/dfb/share/SDL2/test
install test/testtimer $DESTDIR/dfb/share/SDL2/test
install test/testurl $DESTDIR/dfb/share/SDL2/test
install test/testver $DESTDIR/dfb/share/SDL2/test
install test/testviewport $DESTDIR/dfb/share/SDL2/test
test $VK && install test/testvulkan $DESTDIR/dfb/share/SDL2/test
install test/testwm2 $DESTDIR/dfb/share/SDL2/test
install test/testyuv $DESTDIR/dfb/share/SDL2/test
install -m 644 test/testyuv.bmp $DESTDIR/dfb/share/SDL2/test
install test/torturethread $DESTDIR/dfb/share/SDL2/test
install -m 644 test/unifont-13.0.06.hex $DESTDIR/dfb/share/SDL2/test
install -m 644 test/utf8.txt $DESTDIR/dfb/share/SDL2/test

# build.pc
install -d $DESTDIR/dfb/share/pkgconfig
cat > $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc << EOF
Name: SDL2
Version: 2.0.16
Description: Simple DirectMedia Layer library
Requires: $REQUIRES

devel=\\
/dfb/include/SDL2/begin_code.h \\
/dfb/include/SDL2/close_code.h \\
/dfb/include/SDL2/SDL.h \\
/dfb/include/SDL2/SDL_assert.h \\
/dfb/include/SDL2/SDL_atomic.h \\
/dfb/include/SDL2/SDL_audio.h \\
/dfb/include/SDL2/SDL_blendmode.h \\
/dfb/include/SDL2/SDL_clipboard.h \\
/dfb/include/SDL2/SDL_config.h \\
/dfb/include/SDL2/SDL_cpuinfo.h \\
/dfb/include/SDL2/SDL_endian.h \\
/dfb/include/SDL2/SDL_error.h \\
/dfb/include/SDL2/SDL_events.h \\
/dfb/include/SDL2/SDL_filesystem.h \\
/dfb/include/SDL2/SDL_gamecontroller.h \\
/dfb/include/SDL2/SDL_gesture.h \\
/dfb/include/SDL2/SDL_haptic.h \\
/dfb/include/SDL2/SDL_hints.h \\
/dfb/include/SDL2/SDL_joystick.h \\
/dfb/include/SDL2/SDL_keyboard.h \\
/dfb/include/SDL2/SDL_keycode.h \\
/dfb/include/SDL2/SDL_loadso.h \\
/dfb/include/SDL2/SDL_locale.h \\
/dfb/include/SDL2/SDL_log.h \\
/dfb/include/SDL2/SDL_main.h \\
/dfb/include/SDL2/SDL_messagebox.h \\
/dfb/include/SDL2/SDL_misc.h \\
/dfb/include/SDL2/SDL_mouse.h \\
/dfb/include/SDL2/SDL_mutex.h \\
EOF
test $GL && echo /dfb/include/SDL2/SDL_opengl.h \\ >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc
test $GL && echo /dfb/include/SDL2/SDL_opengl_glext.h \\ >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc
test $GL && echo /dfb/include/SDL2/SDL_opengles.h \\ >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc
test $GL && echo /dfb/include/SDL2/SDL_opengles2.h \\ >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc
cat >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc << EOF
/dfb/include/SDL2/SDL_pixels.h \\
/dfb/include/SDL2/SDL_platform.h \\
/dfb/include/SDL2/SDL_power.h \\
/dfb/include/SDL2/SDL_quit.h \\
/dfb/include/SDL2/SDL_rect.h \\
/dfb/include/SDL2/SDL_render.h \\
/dfb/include/SDL2/SDL_rwops.h \\
/dfb/include/SDL2/SDL_scancode.h \\
/dfb/include/SDL2/SDL_sensor.h \\
/dfb/include/SDL2/SDL_shape.h \\
/dfb/include/SDL2/SDL_stdinc.h \\
/dfb/include/SDL2/SDL_surface.h \\
/dfb/include/SDL2/SDL_system.h \\
/dfb/include/SDL2/SDL_thread.h \\
/dfb/include/SDL2/SDL_timer.h \\
/dfb/include/SDL2/SDL_touch.h \\
/dfb/include/SDL2/SDL_version.h \\
/dfb/include/SDL2/SDL_video.h \\
EOF
test $VK && echo /dfb/include/SDL2/SDL_vulkan.h \\ >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc
cat >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc << EOF
/dfb/lib/libSDL2.so \\
/dfb/lib/pkgconfig/sdl2.pc

exec=\\
/dfb/lib/libSDL2-2.0.so.0 \\
/dfb/share/SDL2/test/axis.bmp \\
/dfb/share/SDL2/test/button.bmp \\
/dfb/share/SDL2/test/checkkeys \\
/dfb/share/SDL2/test/checkkeysthreads \\
/dfb/share/SDL2/test/controllermap \\
/dfb/share/SDL2/test/controllermap.bmp \\
/dfb/share/SDL2/test/controllermap_back.bmp \\
/dfb/share/SDL2/test/icon.bmp \\
/dfb/share/SDL2/test/loopwave \\
/dfb/share/SDL2/test/loopwavequeue \\
/dfb/share/SDL2/test/moose.dat \\
/dfb/share/SDL2/test/sample.bmp \\
/dfb/share/SDL2/test/sample.wav \\
/dfb/share/SDL2/test/testatomic \\
/dfb/share/SDL2/test/testaudiocapture \\
/dfb/share/SDL2/test/testaudiohotplug \\
/dfb/share/SDL2/test/testaudioinfo \\
/dfb/share/SDL2/test/testautomation \\
/dfb/share/SDL2/test/testbounds \\
/dfb/share/SDL2/test/testcustomcursor \\
/dfb/share/SDL2/test/testdisplayinfo \\
/dfb/share/SDL2/test/testdraw2 \\
/dfb/share/SDL2/test/testdrawchessboard \\
/dfb/share/SDL2/test/testdropfile \\
/dfb/share/SDL2/test/testerror \\
/dfb/share/SDL2/test/testevdev \\
/dfb/share/SDL2/test/testfile \\
/dfb/share/SDL2/test/testfilesystem \\
/dfb/share/SDL2/test/testgamecontroller \\
/dfb/share/SDL2/test/testgesture \\
EOF
test $GL && echo /dfb/share/SDL2/test/testgl2 \\ >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc
test $GL && echo /dfb/share/SDL2/test/testgles \\ >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc
test $GL && echo /dfb/share/SDL2/test/testgles2 \\ >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc
cat >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc << EOF
/dfb/share/SDL2/test/testhaptic \\
/dfb/share/SDL2/test/testhotplug \\
/dfb/share/SDL2/test/testiconv \\
/dfb/share/SDL2/test/testime \\
/dfb/share/SDL2/test/testintersections \\
/dfb/share/SDL2/test/testjoystick \\
/dfb/share/SDL2/test/testkeys \\
/dfb/share/SDL2/test/testloadso \\
/dfb/share/SDL2/test/testlocale \\
/dfb/share/SDL2/test/testlock \\
/dfb/share/SDL2/test/testmultiaudio \\
/dfb/share/SDL2/test/testoverlay2 \\
/dfb/share/SDL2/test/testplatform \\
/dfb/share/SDL2/test/testpower \\
/dfb/share/SDL2/test/testqsort \\
/dfb/share/SDL2/test/testrelative \\
/dfb/share/SDL2/test/testrendercopyex \\
/dfb/share/SDL2/test/testrendertarget \\
/dfb/share/SDL2/test/testresample \\
/dfb/share/SDL2/test/testrumble \\
/dfb/share/SDL2/test/testscale \\
/dfb/share/SDL2/test/testsem \\
/dfb/share/SDL2/test/testsensor \\
/dfb/share/SDL2/test/testsprite2 \\
/dfb/share/SDL2/test/testspriteminimal \\
/dfb/share/SDL2/test/teststreaming \\
/dfb/share/SDL2/test/testthread \\
/dfb/share/SDL2/test/testtimer \\
/dfb/share/SDL2/test/testurl \\
/dfb/share/SDL2/test/testver \\
/dfb/share/SDL2/test/testviewport \\
EOF
test $VK && echo /dfb/share/SDL2/test/testvulkan \\ >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc
cat >> $DESTDIR/dfb/share/pkgconfig/sdl2-build.pc << EOF
/dfb/share/SDL2/test/testwm2 \\
/dfb/share/SDL2/test/testyuv \\
/dfb/share/SDL2/test/testyuv.bmp \\
/dfb/share/SDL2/test/torturethread \\
/dfb/share/SDL2/test/unifont-13.0.06.hex \\
/dfb/share/SDL2/test/utf8.txt
EOF

exit
--- SDL2-2.0.16.orig/configure.ac
+++ SDL2-2.0.16/configure.ac
@@ -77,7 +77,7 @@
     *-*-nto-qnx*)
         ;;
     *)
-        INCLUDE="$INCLUDE -idirafter $srcdir/src/video/khronos"
+        INCLUDE="$INCLUDE -idirafter $prefix/include"
         ;;
 esac
 
@@ -889,8 +889,8 @@
         LIBS="$alsa_save_LIBS"
         if test x$have_alsa = xyes; then
             AC_ARG_ENABLE(alsa-shared,
-[AS_HELP_STRING([--enable-alsa-shared], [dynamically load ALSA audio support [default=yes]])],
-                          , enable_alsa_shared=yes)
+[AS_HELP_STRING([--enable-alsa-shared], [dynamically load ALSA audio support [default=no]])],
+                          , enable_alsa_shared=no)
             alsa_lib=[`find_lib "libasound.so.*" "$ALSA_LIBS" | sed 's/.*\/\(.*\)/\1/; q'`]
 
             AC_DEFINE(SDL_AUDIO_DRIVER_ALSA, 1, [ ])
@@ -1241,8 +1241,8 @@
             EXTRA_CFLAGS="$EXTRA_CFLAGS $FUSIONSOUND_CFLAGS"
 
             AC_ARG_ENABLE(fusionsound-shared,
-[AS_HELP_STRING([--enable-fusionsound-shared], [dynamically load fusionsound audio support [default=yes]])],
-                          , enable_fusionsound_shared=yes)
+[AS_HELP_STRING([--enable-fusionsound-shared], [dynamically load fusionsound audio support [default=no]])],
+                          , enable_fusionsound_shared=no)
             fusionsound_shared=no
             AC_MSG_CHECKING(for FusionSound dynamic loading support)
             if test x$have_loadso != xyes && \
@@ -2214,8 +2214,8 @@
 
         if test x$video_directfb = xyes; then
             AC_ARG_ENABLE(directfb-shared,
-[AS_HELP_STRING([--enable-directfb-shared], [dynamically load directfb support [default=yes]])],
-                              , enable_directfb_shared=yes)
+[AS_HELP_STRING([--enable-directfb-shared], [dynamically load directfb support [default=no]])],
+                              , enable_directfb_shared=no)
 
             AC_DEFINE(SDL_VIDEO_DRIVER_DIRECTFB, 1, [ ])
             AC_DEFINE(SDL_VIDEO_RENDER_DIRECTFB, 1, [ ])
@@ -2596,6 +2596,12 @@
             # For reasons I am totally unable to see, I get an undefined macro error if
             # I put this in the AC_TRY_COMPILE.
             AC_MSG_WARN([Vulkan does not work on this configuration.])
+        else
+            AC_MSG_CHECKING(for Vulkan headers)
+            AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
+              #include <vulkan/vulkan.h>
+            ]],[])], [],[enable_video_vulkan=no])
+            AC_MSG_RESULT($enable_video_vulkan)
         fi
     fi
     if test x$enable_video_vulkan = xyes; then
--- SDL2-2.0.16.orig/include/SDL.h
+++ SDL2-2.0.16/include/SDL.h
@@ -47,7 +47,6 @@
 #include "SDL_loadso.h"
 #include "SDL_log.h"
 #include "SDL_messagebox.h"
-#include "SDL_metal.h"
 #include "SDL_mutex.h"
 #include "SDL_power.h"
 #include "SDL_render.h"
--- SDL2-2.0.16.orig/src/dynapi/SDL_dynapi_procs.h
+++ SDL2-2.0.16/src/dynapi/SDL_dynapi_procs.h
@@ -780,8 +780,6 @@
 SDL_DYNAPI_PROC(size_t,SDL_RWwrite,(SDL_RWops *a, const void *b, size_t c, size_t d),(a,b,c,d),return)
 SDL_DYNAPI_PROC(int,SDL_RWclose,(SDL_RWops *a),(a),return)
 SDL_DYNAPI_PROC(void*,SDL_LoadFile,(const char *a, size_t *b),(a,b),return)
-SDL_DYNAPI_PROC(SDL_MetalView,SDL_Metal_CreateView,(SDL_Window *a),(a),return)
-SDL_DYNAPI_PROC(void,SDL_Metal_DestroyView,(SDL_MetalView a),(a),)
 SDL_DYNAPI_PROC(int,SDL_LockTextureToSurface,(SDL_Texture *a, const SDL_Rect *b, SDL_Surface **c),(a,b,c),return)
 SDL_DYNAPI_PROC(SDL_bool,SDL_HasARMSIMD,(void),(),return)
 SDL_DYNAPI_PROC(char*,SDL_strtokr,(char *a, const char *b, char **c),(a,b,c),return)
@@ -818,7 +816,6 @@
 SDL_DYNAPI_PROC(char*,SDL_GetErrorMsg,(char *a, int b),(a,b),return)
 SDL_DYNAPI_PROC(void,SDL_LockSensors,(void),(),)
 SDL_DYNAPI_PROC(void,SDL_UnlockSensors,(void),(),)
-SDL_DYNAPI_PROC(void*,SDL_Metal_GetLayer,(SDL_MetalView a),(a),return)
 SDL_DYNAPI_PROC(void,SDL_Metal_GetDrawableSize,(SDL_Window *a, int *b, int *c),(a,b,c),)
 SDL_DYNAPI_PROC(double,SDL_trunc,(double a),(a),return)
 SDL_DYNAPI_PROC(float,SDL_truncf,(float a),(a),return)
--- SDL2-2.0.16.orig/src/render/opengles/SDL_glesfuncs.h
+++ SDL2-2.0.16/src/render/opengles/SDL_glesfuncs.h
@@ -27,10 +27,13 @@
 SDL_PROC(void, glClear, (GLbitfield))
 SDL_PROC(void, glClearColor, (GLclampf, GLclampf, GLclampf, GLclampf))
 SDL_PROC(void, glColor4f, (GLfloat, GLfloat, GLfloat, GLfloat))
+SDL_PROC(void, glColorPointer, (GLint, GLenum, GLsizei, const GLvoid *))
 SDL_PROC(void, glDeleteTextures, (GLsizei, const GLuint *))
+SDL_PROC(void, glDepthFunc, (GLenum))
 SDL_PROC(void, glDisable, (GLenum))
 SDL_PROC(void, glDisableClientState, (GLenum array))
 SDL_PROC(void, glDrawArrays, (GLenum, GLint, GLsizei))
+SDL_PROC(void, glDrawElements, (GLenum, GLsizei, GLenum, const GLvoid *))
 SDL_PROC_OES(void, glDrawTexfOES, (GLfloat, GLfloat, GLfloat, GLfloat, GLfloat))
 SDL_PROC(void, glEnable, (GLenum))
 SDL_PROC(void, glEnableClientState, (GLenum))
@@ -39,12 +42,14 @@
 SDL_PROC(void, glGenTextures, (GLsizei, GLuint *))
 SDL_PROC(GLenum, glGetError, (void))
 SDL_PROC(void, glGetIntegerv, (GLenum, GLint *))
+SDL_PROC(const GLubyte *, glGetString, (GLenum))
 SDL_PROC(void, glLoadIdentity, (void))
 SDL_PROC(void, glMatrixMode, (GLenum))
 SDL_PROC(void, glOrthof, (GLfloat, GLfloat, GLfloat, GLfloat, GLfloat, GLfloat))
 SDL_PROC(void, glPixelStorei, (GLenum, GLint))
 SDL_PROC(void, glReadPixels, (GLint, GLint, GLsizei, GLsizei, GLenum, GLenum, GLvoid*))
 SDL_PROC(void, glScissor, (GLint, GLint, GLsizei, GLsizei))
+SDL_PROC(void, glShadeModel, (GLenum))
 SDL_PROC(void, glTexCoordPointer, (GLint, GLenum, GLsizei, const GLvoid *))
 SDL_PROC(void, glTexEnvf, (GLenum, GLenum, GLfloat))
 SDL_PROC(void, glTexImage2D, (GLenum, GLint, GLint, GLsizei, GLsizei, GLint, GLenum, GLenum, const GLvoid *))
--- SDL2-2.0.16.orig/src/video/SDL_vulkan_internal.h
+++ SDL2-2.0.16/src/video/SDL_vulkan_internal.h
@@ -58,7 +58,7 @@
 #endif
 
 #define VK_NO_PROTOTYPES
-#include "./khronos/vulkan/vulkan.h"
+#include <vulkan/vulkan.h>
 
 #include "SDL_vulkan.h"
 
--- SDL2-2.0.16.orig/src/video/directfb/SDL_DirectFB_events.c
+++ SDL2-2.0.16/src/video/directfb/SDL_DirectFB_events.c
@@ -405,6 +405,8 @@
             break;              /* please gcc */
         }
     }
+
+    (void) kbd_idx;
 }
 
 void
--- SDL2-2.0.16.orig/src/video/directfb/SDL_DirectFB_opengl.c
+++ SDL2-2.0.16/src/video/directfb/SDL_DirectFB_opengl.c
@@ -119,7 +119,13 @@
     if (path == NULL) {
         path = SDL_getenv("SDL_OPENGL_LIBRARY");
         if (path == NULL) {
+#if SDL_VIDEO_OPENGL_ES2
+            path = "libGLESv2.so.2";
+#elif SDL_VIDEO_OPENGL
             path = "libGL.so.1";
+#else /* SDL_VIDEO_OPENGL_ES */
+            path = "libGLESv1_CM.so.1";
+#endif
         }
     }
 
@@ -255,8 +261,9 @@
     for (p = _this->gl_data->firstgl; p != NULL; p = p->next)
         if (p->sdl_window == window && p->is_locked)
         {
-            SDL_DFB_CHECKERR(p->context->Unlock(p->context));
-            p->is_locked = 0;
+#if DIRECTFBGL_INTERFACE_VERSION > 1
+            SDL_DFB_CHECKERR(p->context->SwapBuffers(p->context));
+#endif
         }
 
     SDL_DFB_CHECKERR(windata->window_surface->Flip(windata->window_surface,NULL,  DSFLIP_PIPELINE |DSFLIP_BLIT | DSFLIP_ONSYNC ));
--- SDL2-2.0.16.orig/src/video/directfb/SDL_DirectFB_video.c
+++ SDL2-2.0.16/src/video/directfb/SDL_DirectFB_video.c
@@ -227,13 +227,7 @@
             DirectFBSetOption("disable-module", "x11input");
     }
 
-    devdata->use_linux_input = readBoolEnv(DFBENV_USE_LINUX_INPUT, 1);       /* default: on */
-
-    if (!devdata->use_linux_input)
-    {
-        SDL_DFB_LOG("Disabling linux input\n");
-        DirectFBSetOption("disable-module", "linux_input");
-    }
+    devdata->use_linux_input = readBoolEnv(DFBENV_USE_LINUX_INPUT, 0);
 
     SDL_DFB_CHECKERR(DirectFBCreate(&dfb));
 
--- SDL2-2.0.16.orig/src/video/directfb/SDL_DirectFB_video.h
+++ SDL2-2.0.16/src/video/directfb/SDL_DirectFB_video.h
@@ -42,7 +42,7 @@
     (DFB_COMPILEDVERSION >= DFB_VERSIONNUM(X, Y, Z))
 
 #if (DFB_VERSION_ATLEAST(1,0,0))
-#ifdef SDL_VIDEO_OPENGL
+#if SDL_VIDEO_OPENGL || SDL_VIDEO_OPENGL_ES2 || SDL_VIDEO_OPENGL_ES
 #define SDL_DIRECTFB_OPENGL 1
 #endif
 #else
--- SDL2-2.0.16.orig/src/video/directfb/SDL_DirectFB_window.c
+++ SDL2-2.0.16/src/video/directfb/SDL_DirectFB_window.c
@@ -90,7 +90,7 @@
     desc.height = windata->size.h;
     desc.pixelformat = dispdata->pixelformat;
     desc.surface_caps = DSCAPS_PREMULTIPLIED;
-#if DIRECTFB_MAJOR_VERSION == 1 && DIRECTFB_MINOR_VERSION >= 6
+#if (DFB_VERSION_ATLEAST(1,6,0))
     if (window->flags & SDL_WINDOW_OPENGL) {
         desc.surface_caps |= DSCAPS_GL;
     }
@@ -153,6 +153,7 @@
 
     /* Make it the top most window. */
     SDL_DFB_CHECK(windata->dfbwin->RaiseToTop(windata->dfbwin));
+    SDL_DFB_CHECK(windata->dfbwin->RequestFocus(windata->dfbwin));
 
     /* remember parent */
     /* windata->sdlwin = window; */
--- SDL2-2.0.16.orig/test/Makefile.in
+++ SDL2-2.0.16/test/Makefile.in
@@ -4,7 +4,7 @@
 
 CC      = @CC@
 EXE	= @EXE@
-CFLAGS  = @CFLAGS@ -g
+CFLAGS  = @CFLAGS@ -g -DTESTDATADIR=\"@TESTDATADIR@\"
 LIBS	= @LIBS@
 
 TARGETS = \
@@ -71,7 +71,7 @@
 	torturethread$(EXE) \
 
 	
-@OPENGL_TARGETS@ += testgl2$(EXE) testshader$(EXE)
+@OPENGL_TARGETS@ += testgl2$(EXE)
 @OPENGLES1_TARGETS@ += testgles$(EXE)
 @OPENGLES2_TARGETS@ += testgles2$(EXE)
 
@@ -169,7 +169,7 @@
 	$(CC) -o $@ $^ $(CFLAGS) $(LIBS) @MATHLIB@
 
 testgles$(EXE): $(srcdir)/testgles.c
-	$(CC) -o $@ $^ $(CFLAGS) $(LIBS) @GLESLIB@ @MATHLIB@
+	$(CC) -o $@ $^ $(CFLAGS) $(LIBS) @MATHLIB@
 
 testgles2$(EXE): $(srcdir)/testgles2.c
 	$(CC) -o $@ $^ $(CFLAGS) $(LIBS) @MATHLIB@
--- SDL2-2.0.16.orig/test/configure.ac
+++ SDL2-2.0.16/test/configure.ac
@@ -192,6 +192,12 @@
 fi
 AC_SUBST(SDL_TTF_LIB)
 
+AC_ARG_WITH(testdatadir,
+            [AS_HELP_STRING([--with-testdatadir], [test data directory])],
+            [TESTDATADIR=$with_testdatadir],
+            [TESTDATADIR=.])
+AC_SUBST(TESTDATADIR)
+
 dnl Finally create all the generated files
 AC_CONFIG_FILES([Makefile])
 AC_OUTPUT
--- SDL2-2.0.16.orig/test/controllermap.c
+++ SDL2-2.0.16/test/controllermap.c
@@ -384,10 +384,10 @@
     Uint32 alpha_ticks = 0;
     SDL_JoystickID nJoystickID;
 
-    background_front = LoadTexture(screen, "controllermap.bmp", SDL_FALSE);
-    background_back = LoadTexture(screen, "controllermap_back.bmp", SDL_FALSE);
-    button = LoadTexture(screen, "button.bmp", SDL_TRUE);
-    axis = LoadTexture(screen, "axis.bmp", SDL_TRUE);
+    background_front = LoadTexture(screen, TESTDATADIR"/controllermap.bmp", SDL_FALSE);
+    background_back = LoadTexture(screen, TESTDATADIR"/controllermap_back.bmp", SDL_FALSE);
+    button = LoadTexture(screen, TESTDATADIR"/button.bmp", SDL_TRUE);
+    axis = LoadTexture(screen, TESTDATADIR"/axis.bmp", SDL_TRUE);
     SDL_RaiseWindow(window);
 
     /* scale for platforms that don't give you the window size you asked for. */
--- SDL2-2.0.16.orig/test/loopwave.c
+++ SDL2-2.0.16/test/loopwave.c
@@ -128,7 +128,7 @@
     if (argc > 1) {
         SDL_strlcpy(filename, argv[1], sizeof(filename));
     } else {
-        SDL_strlcpy(filename, "sample.wav", sizeof(filename));
+        SDL_strlcpy(filename, TESTDATADIR"/sample.wav", sizeof(filename));
     }
     /* Load the wave file into memory */
     if (SDL_LoadWAV(filename, &wave.spec, &wave.sound, &wave.soundlen) == NULL) {
--- SDL2-2.0.16.orig/test/loopwavequeue.c
+++ SDL2-2.0.16/test/loopwavequeue.c
@@ -88,7 +88,7 @@
     if (argc > 1) {
         SDL_strlcpy(filename, argv[1], sizeof(filename));
     } else {
-        SDL_strlcpy(filename, "sample.wav", sizeof(filename));
+        SDL_strlcpy(filename, TESTDATADIR"/sample.wav", sizeof(filename));
     }
     /* Load the wave file into memory */
     if (SDL_LoadWAV(filename, &wave.spec, &wave.sound, &wave.soundlen) == NULL) {
--- SDL2-2.0.16.orig/test/testaudiohotplug.c
+++ SDL2-2.0.16/test/testaudiohotplug.c
@@ -154,7 +154,7 @@
     if (argc > 1) {
         SDL_strlcpy(filename, argv[1], sizeof(filename));
     } else {
-        SDL_strlcpy(filename, "sample.wav", sizeof(filename));
+        SDL_strlcpy(filename, TESTDATADIR"/sample.wav", sizeof(filename));
     }
     /* Load the wave file into memory */
     if (SDL_LoadWAV(filename, &spec, &sound, &soundlen) == NULL) {
--- SDL2-2.0.16.orig/test/testautomation_hints.c
+++ SDL2-2.0.16/test/testautomation_hints.c
@@ -39,31 +39,31 @@
   };
 char* _HintsVerbose[] =
   {
-    "SDL_HINT_ACCELEROMETER_AS_JOYSTICK",
-    "SDL_HINT_FRAMEBUFFER_ACCELERATION",
-    "SDL_HINT_GAMECONTROLLERCONFIG",
-    "SDL_HINT_GRAB_KEYBOARD",
-    "SDL_HINT_IDLE_TIMER_DISABLED",
-    "SDL_HINT_JOYSTICK_ALLOW_BACKGROUND_EVENTS",
-    "SDL_HINT_MAC_CTRL_CLICK_EMULATE_RIGHT_CLICK",
-    "SDL_HINT_MOUSE_RELATIVE_MODE_WARP",
-    "SDL_HINT_ORIENTATIONS",
-    "SDL_HINT_RENDER_DIRECT3D_THREADSAFE",
-    "SDL_HINT_RENDER_DRIVER",
-    "SDL_HINT_RENDER_OPENGL_SHADERS",
-    "SDL_HINT_RENDER_SCALE_QUALITY",
-    "SDL_HINT_RENDER_VSYNC",
-    "SDL_HINT_TIMER_RESOLUTION",
-    "SDL_HINT_VIDEO_ALLOW_SCREENSAVER",
-    "SDL_HINT_VIDEO_HIGHDPI_DISABLED",
-    "SDL_HINT_VIDEO_MAC_FULLSCREEN_SPACES",
-    "SDL_HINT_VIDEO_MINIMIZE_ON_FOCUS_LOSS",
-    "SDL_HINT_VIDEO_WINDOW_SHARE_PIXEL_FORMAT",
-    "SDL_HINT_VIDEO_WIN_D3DCOMPILER",
-    "SDL_HINT_VIDEO_X11_XINERAMA",
-    "SDL_HINT_VIDEO_X11_XRANDR",
-    "SDL_HINT_VIDEO_X11_XVIDMODE",
-    "SDL_HINT_XINPUT_ENABLED"
+    "SDL_ACCELEROMETER_AS_JOYSTICK",
+    "SDL_FRAMEBUFFER_ACCELERATION",
+    "SDL_GAMECONTROLLERCONFIG",
+    "SDL_GRAB_KEYBOARD",
+    "SDL_IDLE_TIMER_DISABLED",
+    "SDL_JOYSTICK_ALLOW_BACKGROUND_EVENTS",
+    "SDL_MAC_CTRL_CLICK_EMULATE_RIGHT_CLICK",
+    "SDL_MOUSE_RELATIVE_MODE_WARP",
+    "SDL_ORIENTATIONS",
+    "SDL_RENDER_DIRECT3D_THREADSAFE",
+    "SDL_RENDER_DRIVER",
+    "SDL_RENDER_OPENGL_SHADERS",
+    "SDL_RENDER_SCALE_QUALITY",
+    "SDL_RENDER_VSYNC",
+    "SDL_TIMER_RESOLUTION",
+    "SDL_VIDEO_ALLOW_SCREENSAVER",
+    "SDL_VIDEO_HIGHDPI_DISABLED",
+    "SDL_VIDEO_MAC_FULLSCREEN_SPACES",
+    "SDL_VIDEO_MINIMIZE_ON_FOCUS_LOSS",
+    "SDL_VIDEO_WINDOW_SHARE_PIXEL_FORMAT",
+    "SDL_VIDEO_WIN_D3DCOMPILER",
+    "SDL_VIDEO_X11_XINERAMA",
+    "SDL_VIDEO_X11_XRANDR",
+    "SDL_VIDEO_X11_XVIDMODE",
+    "SDL_XINPUT_ENABLED"
   };
 
 
--- SDL2-2.0.16.orig/test/testcustomcursor.c
+++ SDL2-2.0.16/test/testcustomcursor.c
@@ -231,8 +231,7 @@
     for (i = 0; i < SDL_NUM_SYSTEM_CURSORS; ++i) {
         cursors[1+i] = SDL_CreateSystemCursor((SDL_SystemCursor)i);
         if (!cursors[1+i]) {
-            SDL_Log("Error, couldn't create system cursor %d\n", i);
-            quit(2);
+            break;
         }
     }
     SDL_SetCursor(cursors[0]);
@@ -244,10 +243,14 @@
 #else
     while (!done) {
         loop();
+        SDL_Delay(10);
     }
 #endif
 
     for (i = 0; i < SDL_arraysize(cursors); ++i) {
+        if (!cursors[i])
+            break;
+
         SDL_FreeCursor(cursors[i]);
     }
     quit(0);
--- SDL2-2.0.16.orig/test/testgamecontroller.c
+++ SDL2-2.0.16/test/testgamecontroller.c
@@ -624,10 +624,10 @@
     /* scale for platforms that don't give you the window size you asked for. */
     SDL_RenderSetLogicalSize(screen, SCREEN_WIDTH, SCREEN_HEIGHT);
 
-    background_front = LoadTexture(screen, "controllermap.bmp", SDL_FALSE);
-    background_back = LoadTexture(screen, "controllermap_back.bmp", SDL_FALSE);
-    button = LoadTexture(screen, "button.bmp", SDL_TRUE);
-    axis = LoadTexture(screen, "axis.bmp", SDL_TRUE);
+    background_front = LoadTexture(screen, TESTDATADIR"/controllermap.bmp", SDL_FALSE);
+    background_back = LoadTexture(screen, TESTDATADIR"/controllermap_back.bmp", SDL_FALSE);
+    button = LoadTexture(screen, TESTDATADIR"/button.bmp", SDL_TRUE);
+    axis = LoadTexture(screen, TESTDATADIR"/axis.bmp", SDL_TRUE);
 
     if (!background_front || !background_back || !button || !axis) {
         SDL_DestroyRenderer(screen);
--- SDL2-2.0.16.orig/test/testgles.c
+++ SDL2-2.0.16/test/testgles.c
@@ -24,9 +24,49 @@
 
 #include "SDL_opengles.h"
 
+typedef struct GLES_Context
+{
+#define SDL_PROC(ret,func,params) ret (APIENTRY *func) params;
+#define SDL_PROC_OES SDL_PROC
+#include "../src/render/opengles/SDL_glesfuncs.h"
+#undef SDL_PROC
+#undef SDL_PROC_OES
+} GLES_Context;
+
 static SDLTest_CommonState *state;
 static SDL_GLContext *context = NULL;
 static int depth = 16;
+static GLES_Context ctx;
+
+static int LoadContext(GLES_Context * data)
+{
+#if SDL_VIDEO_DRIVER_UIKIT
+#define __SDL_NOGETPROCADDR__
+#elif SDL_VIDEO_DRIVER_ANDROID
+#define __SDL_NOGETPROCADDR__
+#elif SDL_VIDEO_DRIVER_PANDORA
+#define __SDL_NOGETPROCADDR__
+#endif
+
+#if defined __SDL_NOGETPROCADDR__
+#define SDL_PROC(ret,func,params) data->func=func;
+#else
+#define SDL_PROC(ret,func,params) \
+    do { \
+        data->func = SDL_GL_GetProcAddress(#func); \
+        if ( ! data->func ) { \
+            return SDL_SetError("Couldn't load GLES function %s: %s", #func, SDL_GetError()); \
+        } \
+    } while ( 0 );
+#endif /* __SDL_NOGETPROCADDR__ */
+
+#define SDL_PROC_OES SDL_PROC
+
+#include "../src/render/opengles/SDL_glesfuncs.h"
+#undef SDL_PROC
+#undef SDL_PROC_OES
+    return 0;
+}
 
 /* Call this instead of exit(), so we can clean up SDL: atexit() is evil. */
 static void
@@ -85,18 +125,18 @@
 
 
     /* Do our drawing, too. */
-    glClearColor(0.0, 0.0, 0.0, 1.0);
-    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+    ctx.glClearColor(0.0, 0.0, 0.0, 1.0);
+    ctx.glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
 
     /* Draw the cube */
-    glColorPointer(4, GL_UNSIGNED_BYTE, 0, color);
-    glEnableClientState(GL_COLOR_ARRAY);
-    glVertexPointer(3, GL_FLOAT, 0, cube);
-    glEnableClientState(GL_VERTEX_ARRAY);
-    glDrawElements(GL_TRIANGLES, 36, GL_UNSIGNED_BYTE, indices);
+    ctx.glColorPointer(4, GL_UNSIGNED_BYTE, 0, color);
+    ctx.glEnableClientState(GL_COLOR_ARRAY);
+    ctx.glVertexPointer(3, GL_FLOAT, 0, cube);
+    ctx.glEnableClientState(GL_VERTEX_ARRAY);
+    ctx.glDrawElements(GL_TRIANGLES, 36, GL_UNSIGNED_BYTE, indices);
 
-    glMatrixMode(GL_MODELVIEW);
-    glRotatef(5.0, 1.0, 1.0, 1.0);
+    ctx.glMatrixMode(GL_MODELVIEW);
+    ctx.glRotatef(5.0, 1.0, 1.0, 1.0);
 }
 
 int
@@ -188,6 +228,13 @@
         }
     }
 
+    /* Important: call this *after* creating the context */
+    if (LoadContext(&ctx) < 0) {
+        SDL_Log("Could not load GLES functions\n");
+        quit(2);
+        return 0;
+    }
+
     if (state->render_flags & SDL_RENDERER_PRESENTVSYNC) {
         SDL_GL_SetSwapInterval(1);
     } else {
@@ -197,10 +244,10 @@
     SDL_GetCurrentDisplayMode(0, &mode);
     SDL_Log("Screen bpp: %d\n", SDL_BITSPERPIXEL(mode.format));
     SDL_Log("\n");
-    SDL_Log("Vendor     : %s\n", glGetString(GL_VENDOR));
-    SDL_Log("Renderer   : %s\n", glGetString(GL_RENDERER));
-    SDL_Log("Version    : %s\n", glGetString(GL_VERSION));
-    SDL_Log("Extensions : %s\n", glGetString(GL_EXTENSIONS));
+    SDL_Log("Vendor     : %s\n", ctx.glGetString(GL_VENDOR));
+    SDL_Log("Renderer   : %s\n", ctx.glGetString(GL_RENDERER));
+    SDL_Log("Version    : %s\n", ctx.glGetString(GL_VERSION));
+    SDL_Log("Extensions : %s\n", ctx.glGetString(GL_EXTENSIONS));
     SDL_Log("\n");
 
     status = SDL_GL_GetAttribute(SDL_GL_RED_SIZE, &value);
@@ -271,15 +318,15 @@
         }
 
         aspectAdjust = (4.0f / 3.0f) / ((float)state->window_w / state->window_h);
-        glViewport(0, 0, state->window_w, state->window_h);
-        glMatrixMode(GL_PROJECTION);
-        glLoadIdentity();
-        glOrthof(-2.0, 2.0, -2.0 * aspectAdjust, 2.0 * aspectAdjust, -20.0, 20.0);
-        glMatrixMode(GL_MODELVIEW);
-        glLoadIdentity();
-        glEnable(GL_DEPTH_TEST);
-        glDepthFunc(GL_LESS);
-        glShadeModel(GL_SMOOTH);
+        ctx.glViewport(0, 0, state->window_w, state->window_h);
+        ctx.glMatrixMode(GL_PROJECTION);
+        ctx.glLoadIdentity();
+        ctx.glOrthof(-2.0, 2.0, -2.0 * aspectAdjust, 2.0 * aspectAdjust, -20.0, 20.0);
+        ctx.glMatrixMode(GL_MODELVIEW);
+        ctx.glLoadIdentity();
+        ctx.glEnable(GL_DEPTH_TEST);
+        ctx.glDepthFunc(GL_LESS);
+        ctx.glShadeModel(GL_SMOOTH);
     }
 
     /* Main render loop */
@@ -302,7 +349,7 @@
                                     break;
                                 }
                                 /* Change view port to the new window dimensions */
-                                glViewport(0, 0, event.window.data1, event.window.data2);
+                                ctx.glViewport(0, 0, event.window.data1, event.window.data2);
                                 /* Update window content */
                                 Render();
                                 SDL_GL_SwapWindow(state->windows[i]);
--- SDL2-2.0.16.orig/test/testgles2.c
+++ SDL2-2.0.16/test/testgles2.c
@@ -22,8 +22,10 @@
 
 #if defined(__IPHONEOS__) || defined(__ANDROID__) || defined(__EMSCRIPTEN__) || defined(__NACL__) \
     || defined(__WINDOWS__) || defined(__LINUX__)
+#ifndef HAVE_OPENGLES2
 #define HAVE_OPENGLES2
 #endif
+#endif
 
 #ifdef HAVE_OPENGLES2
 
--- SDL2-2.0.16.orig/test/testiconv.c
+++ SDL2-2.0.16/test/testiconv.c
@@ -53,7 +53,7 @@
     SDL_LogSetPriority(SDL_LOG_CATEGORY_APPLICATION, SDL_LOG_PRIORITY_INFO);
 
     if (!argv[1]) {
-        argv[1] = "utf8.txt";
+        argv[1] = TESTDATADIR"/utf8.txt";
     }
     file = fopen(argv[1], "rb");
     if (!file) {
--- SDL2-2.0.16.orig/test/testime.c
+++ SDL2-2.0.16/test/testime.c
@@ -633,7 +633,7 @@
 {
     int i, done;
     SDL_Event event;
-    const char *fontname = DEFAULT_FONT;
+    const char *fontname = TESTDATADIR"/"DEFAULT_FONT;
 
     /* Enable standard application logging */
     SDL_LogSetPriority(SDL_LOG_CATEGORY_APPLICATION, SDL_LOG_PRIORITY_INFO);
--- SDL2-2.0.16.orig/test/testmultiaudio.c
+++ SDL2-2.0.16/test/testmultiaudio.c
@@ -181,7 +181,7 @@
         SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, "Don't see any specific audio devices!\n");
     } else {
         if (argv[1] == NULL) {
-            argv[1] = "sample.wav";
+            argv[1] = TESTDATADIR"/sample.wav";
         }
 
         /* Load the wave file into memory */
--- SDL2-2.0.16.orig/test/testoverlay2.c
+++ SDL2-2.0.16/test/testoverlay2.c
@@ -315,7 +315,7 @@
     }
 
     /* load the trojan moose images */
-    handle = SDL_RWFromFile("moose.dat", "rb");
+    handle = SDL_RWFromFile(TESTDATADIR"/moose.dat", "rb");
     if (handle == NULL) {
         SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, "Can't find the file moose.dat !\n");
         SDL_free(RawMooseData);
--- SDL2-2.0.16.orig/test/testrendercopyex.c
+++ SDL2-2.0.16/test/testrendercopyex.c
@@ -186,8 +186,8 @@
 
         drawstate->window = state->windows[i];
         drawstate->renderer = state->renderers[i];
-        drawstate->sprite = LoadTexture(drawstate->renderer, "icon.bmp", SDL_TRUE);
-        drawstate->background = LoadTexture(drawstate->renderer, "sample.bmp", SDL_FALSE);
+        drawstate->sprite = LoadTexture(drawstate->renderer, TESTDATADIR"/icon.bmp", SDL_TRUE);
+        drawstate->background = LoadTexture(drawstate->renderer, TESTDATADIR"/sample.bmp", SDL_FALSE);
         if (!drawstate->sprite || !drawstate->background) {
             quit(2);
         }
--- SDL2-2.0.16.orig/test/testrendertarget.c
+++ SDL2-2.0.16/test/testrendertarget.c
@@ -292,11 +292,11 @@
         drawstate->window = state->windows[i];
         drawstate->renderer = state->renderers[i];
         if (test_composite) {
-            drawstate->sprite = LoadTexture(drawstate->renderer, "icon-alpha.bmp", SDL_TRUE);
+            drawstate->sprite = LoadTexture(drawstate->renderer, TESTDATADIR"/icon-alpha.bmp", SDL_TRUE);
         } else {
-            drawstate->sprite = LoadTexture(drawstate->renderer, "icon.bmp", SDL_TRUE);
+            drawstate->sprite = LoadTexture(drawstate->renderer, TESTDATADIR"/icon.bmp", SDL_TRUE);
         }
-        drawstate->background = LoadTexture(drawstate->renderer, "sample.bmp", SDL_FALSE);
+        drawstate->background = LoadTexture(drawstate->renderer, TESTDATADIR"/sample.bmp", SDL_FALSE);
         if (!drawstate->sprite || !drawstate->background) {
             quit(2);
         }
--- SDL2-2.0.16.orig/test/testscale.c
+++ SDL2-2.0.16/test/testscale.c
@@ -176,8 +176,8 @@
 
         drawstate->window = state->windows[i];
         drawstate->renderer = state->renderers[i];
-        drawstate->sprite = LoadTexture(drawstate->renderer, "icon.bmp", SDL_TRUE);
-        drawstate->background = LoadTexture(drawstate->renderer, "sample.bmp", SDL_FALSE);
+        drawstate->sprite = LoadTexture(drawstate->renderer, TESTDATADIR"/icon.bmp", SDL_TRUE);
+        drawstate->background = LoadTexture(drawstate->renderer, TESTDATADIR"/sample.bmp", SDL_FALSE);
         if (!drawstate->sprite || !drawstate->background) {
             quit(2);
         }
--- SDL2-2.0.16.orig/test/testsprite2.c
+++ SDL2-2.0.16/test/testsprite2.c
@@ -283,7 +283,7 @@
 {
     int i;
     Uint64 seed;
-    const char *icon = "icon.bmp";
+    const char *icon = TESTDATADIR"/icon.bmp";
 
     /* Initialize parameters */
     num_sprites = NUM_SPRITES;
--- SDL2-2.0.16.orig/test/testspriteminimal.c
+++ SDL2-2.0.16/test/testspriteminimal.c
@@ -132,7 +132,8 @@
 
     /* Check for events */
     while (SDL_PollEvent(&event)) {
-        if (event.type == SDL_QUIT || event.type == SDL_KEYDOWN) {
+        if (event.type == SDL_QUIT ||
+            event.type == SDL_KEYDOWN && event.key.keysym.sym == SDLK_ESCAPE) {
             done = 1;
         }
     }
@@ -158,7 +159,7 @@
         quit(2);
     }
 
-    if (LoadSprite("icon.bmp") < 0) {
+    if (LoadSprite(TESTDATADIR"/icon.bmp") < 0) {
         quit(2);
     }
 
--- SDL2-2.0.16.orig/test/teststreaming.c
+++ SDL2-2.0.16/test/teststreaming.c
@@ -138,7 +138,7 @@
     }
 
     /* load the moose images */
-    handle = SDL_RWFromFile("moose.dat", "rb");
+    handle = SDL_RWFromFile(TESTDATADIR"/moose.dat", "rb");
     if (handle == NULL) {
         SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, "Can't find the file moose.dat !\n");
         quit(2);
--- SDL2-2.0.16.orig/test/testviewport.c
+++ SDL2-2.0.16/test/testviewport.c
@@ -229,7 +229,7 @@
         quit(2);
     }
 
-    if (LoadSprite("icon.bmp", state->renderers[0]) < 0) {
+    if (LoadSprite(TESTDATADIR"/icon.bmp", state->renderers[0]) < 0) {
         quit(2);
     }
 
--- SDL2-2.0.16.orig/test/testvulkan.c
+++ SDL2-2.0.16/test/testvulkan.c
@@ -27,12 +27,7 @@
 #else
 
 #define VK_NO_PROTOTYPES
-#ifdef HAVE_VULKAN_H
 #include <vulkan/vulkan.h>
-#else
-/* SDL includes a copy for building on systems without the Vulkan SDK */
-#include "../src/video/khronos/vulkan/vulkan.h"
-#endif
 #include "SDL_vulkan.h"
 
 #ifndef UINT64_MAX /* VS2008 */
--- SDL2-2.0.16.orig/test/testyuv.c
+++ SDL2-2.0.16/test/testyuv.c
@@ -329,7 +329,7 @@
     if (argv[arg]) {
         filename = argv[arg];
     } else {
-        filename = "testyuv.bmp";
+        filename = TESTDATADIR"/testyuv.bmp";
     }
     original = SDL_ConvertSurfaceFormat(SDL_LoadBMP(filename), SDL_PIXELFORMAT_RGB24, 0);
     if (!original) {
