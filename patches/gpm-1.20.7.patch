# This file is part of HiGFXback

# requires
REQUIRES="autotools-wrappers-lt-build byacc-build"

pkg-config --exists --print-errors $REQUIRES || exit 1

# configure (ac-2.69; lt-2.4.2)
cat << eof > configure.ac
AC_INIT([gpm],[$(grep '^[[:digit:]]' doc/changelog | head -n1 | cut -d: -f1)],[http://www.nico.schottelius.org/software/gpm/])
releasedate="$(grep '^[[:digit:]]' doc/changelog | head -n1 | cut -d: -f2)"
release="$(grep '^[[:digit:]]' doc/changelog | head -n1 | cut -d: -f1)"
eof
cat configure.ac.footer >> configure.ac
libtoolize -c -f -i; cat m4/* acinclude.m4 > aclocal.m4; autoconf; autoheader
YACC=byacc ./configure --disable-static --without-curses --sbindir=/bin --prefix=

# build
make

# install
install -d $DESTDIR/bin
install src/gpm $DESTDIR/bin
install src/prog/display-buttons $DESTDIR/bin
install src/prog/display-coords $DESTDIR/bin
install src/prog/disable-paste $DESTDIR/bin
install src/prog/gpm-root $DESTDIR/bin
install src/prog/mev $DESTDIR/bin
install -d $DESTDIR/etc
install -m 644 conf/gpm-root.conf $DESTDIR/etc
install -d $DESTDIR/include
install -m 644 src/headers/gpm.h $DESTDIR/include
install -d $DESTDIR/lib
install src/lib/libgpm.so.2.* $DESTDIR/lib/libgpm.so.2
ln -sf libgpm.so.2 $DESTDIR/lib/libgpm.so
install -d $DESTDIR/lib/pkgconfig
install -m 644 src/gpm.pc $DESTDIR/lib/pkgconfig

# build.pc
install -d $DESTDIR/share/pkgconfig
cat > $DESTDIR/share/pkgconfig/gpm-build.pc << EOF
Name: gpm
Version: 1.20.7
Description: General Purpose Mouse
Requires: $REQUIRES

devel=\\
/include/gpm.h \\
/lib/libgpm.so \\
/lib/pkgconfig/gpm.pc

exec=\\
/bin/display-buttons \\
/bin/display-coords \\
/bin/disable-paste \\
/bin/gpm \\
/bin/gpm-root \\
/bin/mev \\
/etc/gpm-root.conf \\
/lib/libgpm.so.2
EOF

exit
--- gpm-1.20.7.orig/Makefile.in
+++ gpm-1.20.7/Makefile.in
@@ -66,6 +66,7 @@
 
 installdirs:
 	$(MKDIR) $(libdir) $(bindir) $(sbindir) $(includedir) $(sysconfdir); \
+	$(MKDIR) $(libdir)/pkgconfig; \
 	if test "x$(ELISP)" != "x" ; then \
 		$(MKDIR) $(lispdir) ; \
 	fi
--- gpm-1.20.7.orig/config/ltmain.sh
+++ gpm-1.20.7/config/ltmain.sh
@@ -0,0 +1 @@
+# libtool (GNU libtool) 2.4.2
--- gpm-1.20.7.orig/configure
+++ gpm-1.20.7/configure
@@ -0,0 +1 @@
+# Generated by GNU Autoconf 2.69 for gpm 1.20.7.
--- gpm-1.20.7.orig/configure.ac.footer
+++ gpm-1.20.7/configure.ac.footer
@@ -8,6 +8,7 @@
 AC_CONFIG_SRCDIR([src/daemon/main.c])
 AC_CONFIG_AUX_DIR([config])
 AC_CONFIG_HEADER([src/headers/config.h])
+AC_CONFIG_MACRO_DIR([m4])
 
 AC_CANONICAL_HOST
 
@@ -154,4 +155,4 @@
 
 dnl AC_DEFINE_UNQUOTED(SYSCONFDIR,"$sysconfdir")
 dnl AC_DEFINE_UNQUOTED(SBINDIR,"$sbindir")
-AC_OUTPUT(Makefile.include Makefile doc/Makefile src/Makefile contrib/Makefile doc/doc.gpm)
+AC_OUTPUT(Makefile.include Makefile doc/Makefile src/Makefile src/gpm.pc contrib/Makefile doc/doc.gpm)
--- gpm-1.20.7.orig/doc/Makefile.in
+++ gpm-1.20.7/doc/Makefile.in
@@ -119,7 +119,7 @@
 	$(INSTALL_DATA) -m 644 gpm-root.1     $(man1dir)
 	$(INSTALL_DATA) -m 644 gpm-types.7    $(man7dir)
 	$(INSTALL_DATA) -m 644 gpm.8          $(man8dir)
-	$(INSTALL_DATA) -m 644 $(srcdir)/gpm.info       $(infodir)
+	-$(INSTALL_DATA) -m 644 $(srcdir)/gpm.info       $(infodir)
 	# Use install-info if available
 	-if $(SHELL) -c 'install-info --version' >/dev/null 2>&1; then \
 	  if [ -f $(infodir)/dir ] ; then \
--- gpm-1.20.7.orig/src/Makefile.in
+++ gpm-1.20.7/src/Makefile.in
@@ -79,7 +79,7 @@
 #		| $(SED) '\''s/\($*\)\.o\([ :]*\)/\1.o \1.lo\2/g'\'' > $(DEPDIR)/$@'
 
 # Do it all!
-all:	gpm lib/libgpm.so.@abi_lev@ @LIBGPM_A@ $(PROG)
+all:	gpm lib/libgpm.so.@abi_lev@ lib/libgpm.so @LIBGPM_A@ $(PROG)
 
 gpm:	$(GOBJ)
 	$(CC) @LDFLAGS@ $(LDFLAGS) -o $@ $(GOBJ) @LIBS@ $(LIBS) -lm
@@ -114,13 +114,12 @@
 	# headache in cases like this
 	if test "x@SHLIB@" != "x" ; then \
 		$(INSTALL_DATA) -m 644 lib/libgpm.so.@abi_full@ $(libdir)/libgpm.so.@abi_full@	;	\
-		cd $(libdir) && $(LN_S) -f libgpm.so.@abi_full@ libgpm.so.@abi_lev@ 					;	\
+		cd $(libdir) && $(LN_S) -f libgpm.so.@abi_full@ libgpm.so.@abi_lev@ && $(LN_S) -f libgpm.so.@abi_lev@ libgpm.so	;	\
       echo "WARNING: We installed a lib, you should now call ldconfig" 						; 	\
       echo "f.i.: ldconfig -n -l $(libdir)/libgpm.so.@abi_full@" 								;	\
       echo "Or to update everything just type ldconfig"											;	\
 	fi
-#			The unversioned files seems to be not needed -> correct me, if I am wrong.
-#			&& $(LN_S) -f libgpm.so.@abi_lev@  libgpm.so 											;	\
+	$(INSTALL_DATA) -m 644 $(srcdir)/gpm.pc $(libdir)/pkgconfig/gpm.pc
 
    # prog/
 	for i in $(PROG); do \
@@ -168,9 +167,9 @@
 	@LDFLAGS@ $(LDFLAGS) -o lib/libgpm.so.@abi_full@ $^ @LIBS@ @SHARED_LIBS@ $(LIBS)	
 lib/libgpm.so.@abi_lev@:	lib/libgpm.so.@abi_full@
 	$(LN_S) -f libgpm.so.@abi_full@ lib/libgpm.so.@abi_lev@
-# unneeded, isn't it?
-#lib/libgpm.so:	lib/libgpm.so.@abi_full@
-#	$(LN_S) -f libgpm.so.@abi_full@ lib/libgpm.so
+
+lib/libgpm.so:	lib/libgpm.so.@abi_full@
+	$(LN_S) -f libgpm.so.@abi_full@ lib/libgpm.so
 
 include $(DEPFILE)
 
@@ -179,7 +178,7 @@
 
 ## Cleanup
 clean:
-	rm -f gpm lib/libgpm.a lib/libgpm.so.* $(RDEPS)
+	rm -f gpm lib/libgpm.a lib/libgpm.so* $(RDEPS)
 	rm -f core *~ $(GOBJ) $(LOBJ) $(POBJ) $(PICS) gpm-root.c $(DEPFILE)
 	rm -f $(PROG) $(POBJ) prog/gpm-root.c prog/open_console.o
 
--- gpm-1.20.7.orig/src/gpm.pc.in
+++ gpm-1.20.7/src/gpm.pc.in
@@ -0,0 +1,11 @@
+prefix=@prefix@
+exec_prefix=@exec_prefix@
+libdir=@libdir@
+includedir=@includedir@
+
+Name: @PACKAGE_NAME@
+Description: general purpose mouse library
+Version: @PACKAGE_VERSION@
+
+Libs: -L${libdir} -lgpm
+Cflags: -I${includedir}
--- gpm-1.20.7.orig/src/mice.c
+++ gpm-1.20.7/src/mice.c
@@ -254,6 +254,35 @@
    }
    return 0;
 }
+
+static int M_usbtablet (Gpm_Event * state, unsigned char *data)
+{
+   struct input_event thisevent;
+   (void) memcpy (&thisevent, data, sizeof (struct input_event));
+   state->dx = state->dy = state->wdx = state->wdy = 0;
+   if (thisevent.type == EV_ABS) {
+      if (thisevent.code == REL_X) {
+         state->x = thisevent.value * (win.ws_col + 1) / 32767;
+         realposx = thisevent.value * REALPOS_MAX / 32767;
+      } else if (thisevent.code == REL_Y) {
+         state->y = thisevent.value * (win.ws_row + 1) / 32767;
+         realposy = thisevent.value * REALPOS_MAX / 3267;
+      }
+   } else if (thisevent.type == EV_REL) {
+      if (thisevent.code == REL_WHEEL)
+         state->wdy = thisevent.value;
+      else if (thisevent.code == REL_HWHEEL)
+         state->wdx = thisevent.value;
+   } else if (thisevent.type == EV_KEY) {
+      switch (thisevent.code) {
+         case BTN_LEFT:    state->buttons ^= GPM_B_LEFT;    break;
+         case BTN_MIDDLE:  state->buttons ^= GPM_B_MIDDLE;  break;
+         case BTN_RIGHT:   state->buttons ^= GPM_B_RIGHT;   break;
+         case BTN_SIDE:    state->buttons ^= GPM_B_MIDDLE;  break;
+      }
+   }
+   return 0;
+}
 #endif /* HAVE_LINUX_INPUT_H */
 
 static int M_ms(Gpm_Event *state,  unsigned char *data)
@@ -2404,6 +2433,9 @@
    {"evdev", "Linux Event Device",
             "", M_evdev, I_empty, STD_FLG,
                         {0x00, 0x00, 0x00, 0x00} , 16, 16, 0, 0, NULL},
+   {"usbtablet", "USB Tablet (QEMU or VirtualBox)",
+            "", M_usbtablet, I_empty, STD_FLG,
+                        {0x00, 0x00, 0x00, 0x00} , 24, 24, 0, 1, NULL},
 #endif /* HAVE_LINUX_INPUT_H */
    {"exps2",   "IntelliMouse Explorer (ps2) - 3 buttons, wheel unused",
            "ExplorerPS/2", M_imps2, I_exps2, STD_FLG,
