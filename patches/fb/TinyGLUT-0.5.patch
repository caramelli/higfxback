# This file is part of HiGFXback

# requires
REQUIRES="autotools-wrappers-lt-build egl-opengl-stubs-build"

PKG_CONFIG_PATH=/fb/share/pkgconfig pkg-config --exists --print-errors $REQUIRES || exit 1

pkg-config --exists check-build libfiu-build && REQUIRES="$REQUIRES check-build libfiu-build"

# configure (ac-2.71; am-1.16; lt-2.4.7)
libtoolize -c -f; aclocal; autoconf; automake -a -c
PKG_CONFIG_PATH=/fb/lib/pkgconfig LDFLAGS=-Wl,-rpath,/fb/lib ./configure --prefix=/fb

# build
make

# install
install -d $DESTDIR/fb/include/GL
install -m 644 glut.h $DESTDIR/fb/include/GL/tinyglut.h
ln -sf tinyglut.h $DESTDIR/fb/include/GL/glut.h
install -d $DESTDIR/fb/lib
install .libs/libglut.so.3 $DESTDIR/fb/lib/libtinyglut.so.3
ln -sf libtinyglut.so.3 $DESTDIR/fb/lib/libglut.so.3
ln -sf libglut.so.3 $DESTDIR/fb/lib/libglut.so
install -d $DESTDIR/fb/lib/glut/backends
install .libs/egl_plugin.so $DESTDIR/fb/lib/glut/backends
install .libs/glfbdev_plugin.so $DESTDIR/fb/lib/glut/backends
install -d $DESTDIR/fb/lib/glut/platforms
install .libs/fbdev_plugin.so $DESTDIR/fb/lib/glut/platforms
install -d $DESTDIR/fb/lib/pkgconfig
install -m 644 glut.pc $DESTDIR/fb/lib/pkgconfig/tinyglut.pc
ln -sf tinyglut.pc $DESTDIR/fb/lib/pkgconfig/glut.pc

# build.pc
install -d $DESTDIR/fb/share/pkgconfig
cat > $DESTDIR/fb/share/pkgconfig/tinyglut-build.pc << EOF
Name: TinyGLUT
Version: 0.5
Description: OpenGL Utility Toolkit
Requires: $REQUIRES

devel=\\
/fb/include/GL/glut.h \\
/fb/include/GL/tinyglut.h \\
/fb/lib/libglut.so \\
/fb/lib/pkgconfig/glut.pc \\
/fb/lib/pkgconfig/tinyglut.pc

exec=\\
/fb/lib/libglut.so.3 \\
/fb/lib/glut/backends/egl_plugin.so \\
/fb/lib/glut/backends/glfbdev_plugin.so \\
/fb/lib/glut/platforms/fbdev_plugin.so \\
/fb/lib/libtinyglut.so.3
EOF
ln -sf tinyglut-build.pc $DESTDIR/fb/share/pkgconfig/glut-build.pc

exit

# patch
--- TinyGLUT-0.5.orig/Makefile.in
+++ TinyGLUT-0.5/Makefile.in
@@ -0,0 +1 @@
+# Makefile.in generated by automake 1.16.5
--- TinyGLUT-0.5.orig/configure
+++ TinyGLUT-0.5/configure
@@ -0,0 +1 @@
+# Generated by GNU Autoconf 2.71
--- TinyGLUT-0.5.orig/glut-tests.c
+++ TinyGLUT-0.5/glut-tests.c
@@ -50,27 +50,32 @@
   event.code = REL_X;
   event.value = 1;
   write(uinput_mouse, &event, sizeof(struct input_event));
-  sleep(1);
   event.code = REL_Y;
   event.value = 1;
   write(uinput_mouse, &event, sizeof(struct input_event));
-  sleep(1);
+  event.type = EV_SYN;
+  event.code = SYN_REPORT;
+  write(uinput_mouse, &event, sizeof(struct input_event));
 
   event.type = EV_KEY;
   event.code = KEY_F1;
   event.value = 1;
   write(uinput_keyboard, &event, sizeof(struct input_event));
-  sleep(1);
   event.value = 0;
   write(uinput_keyboard, &event, sizeof(struct input_event));
-  sleep(1);
+  event.type = EV_SYN;
+  event.code = SYN_REPORT;
+  write(uinput_keyboard, &event, sizeof(struct input_event));
+
+  event.type = EV_KEY;
   event.code = KEY_ESC;
   event.value = 1;
   write(uinput_keyboard, &event, sizeof(struct input_event));
-  sleep(1);
   event.value = 0;
   write(uinput_keyboard, &event, sizeof(struct input_event));
-  sleep(1);
+  event.type = EV_SYN;
+  event.code = SYN_REPORT;
+  write(uinput_keyboard, &event, sizeof(struct input_event));
 }
 
 static void glutReshape(int width, int height)
@@ -117,14 +122,10 @@
   ck_assert_int_eq(glutGetError(), GLUT_DISPLAY_EXIST);
   glutExit();
 
-  char *backend = getenv("GLUT_BACKEND");
-  unsetenv("GLUT_BACKEND");
-  glutInit(NULL, NULL);
-  ck_assert_int_eq(glutGetError(), GLUT_BAD_BACKEND);
   setenv("GLUT_BACKEND", "none", 1);
   glutInit(NULL, NULL);
   ck_assert_int_eq(glutGetError(), GLUT_BAD_BACKEND);
-  setenv("GLUT_BACKEND", backend, 1);
+  unsetenv("GLUT_BACKEND");
 
   fiu_enable("BACKEND_ENOMEM", 1, NULL, FIU_ONETIME);
   glutInit(NULL, NULL);
--- TinyGLUT-0.5.orig/ltmain.sh
+++ TinyGLUT-0.5/ltmain.sh
@@ -0,0 +1 @@
+# libtool (GNU libtool) 2.4.7

# source
https://github.com/caramelli/TinyGLUT/archive/v0.5/TinyGLUT-0.5.tar.gz
